{% extends "two_factor/_base_focus.html" %}
{% load i18n %}

{% block content %}
  <form action="" method="post">
    {% csrf_token %}
      <div class="card card-default">
      <div class="card-heading">
          {% trans "Enable Two-Factor Authentication" %}
          <span
            class="glyphicon glyphicon-question-sign"
            data-bs-toggle="popover"
            data-bs-animation="false"
            data-bs-html="true"
            data-bs-placement="bottom"
            data-bs-trigger="hover"
            data-bs-original-title='<b>{% trans "Two-factor authentication" %}</b>'
            data-bs-content="
                {% trans 'A new security feature, two factor authentication, is now available. If enabled, in addition to your password, you will be required to provide a verification code in order to log in.' %}
                <br><br>
                {% trans 'You may already be familiar with this security feature, as it is already used on many online banking websites, and by major email providers.' %}
                <br><br>
                {% trans 'When you log into the Registry, you already use a password to verify your identity. If you choose to enable two-factor authentication, you will be asked to provide another verification code in order to log in.' %}
                <br><br>
                {% trans 'Enabling two factor authentication is not required, but it is highly recommended.' %}
                <br><br>
                {% trans 'You will need a smartphone with an authenticator app such as \'Google Authenticator\'. This particular app is available on both Android and iOS mobile devices.' %}
                <br><br>
                {% trans 'If two-factor authentication is enabled, you will be asked for your username and password, and then you will be asked to enter the token generated by your token generator. Open your authenticator app (such as Google Authenticator), and enter the token. You will then be logged into the Registry.' %}
                <br><br>
                {% trans 'Click \'Next\' to progress through the wizard to enable two factor authentication.' %}"
            >
          </span>
        </div>
        <div class="card-body">
          <div class="row">
            {% if wizard.steps.current == 'welcome' %}
              <div class="col-xs-12">
                <p>{% blocktrans %}You are about to take your account security to the next level. Follow the steps in this wizard to enable two-factor authentication.{% endblocktrans %}</p>
              </div>
            {% elif wizard.steps.current == 'generator' %}
              <div class="col-xs-12">
                <p>{% blocktrans %}To start using a token generator, please use your smartphone to scan the QR code below. For example, use Google Authenticator. Then, enter the token generated by the app.{% endblocktrans %}</p>
              </div>
              <div class="col-xs-12">
                <img class="center-block" src="{{ QR_URL }}" alt="QR Code" />
              </div>
              <div class="col-xs-12">
                <p>{% blocktrans %}For manual setup use the time-based key below:{% endblocktrans %}</p>

                <div class="lead">{{ request.session.two_fact_auth_key }}</div>
              </div>
            {% endif %}
          </div>

          {% if form.token.errors %}
            <div class="row">
              <div class="col-xs-12">
                <div class="alert alert-danger" role="alert">
                  <div class="alert-text"></div>
                  <div class="row">
                    {% if form.token.errors|length > 1 %}
                      <ul>
                        {% for err in form.token.errors %}
                          <li>{{ err }}</li>
                        {% endfor %}
                      </ul>
                    {% else %}
                      {% for err in form.token.errors %}
                        <div class="text-center">{{ err }}</div>
                      {% endfor %}
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endif %}

          {% if wizard.steps.current == 'generator' %}
            <input type="hidden" name="setup_view-current_step" value="generator" id="id_setup_view-current_step">

            <div class="form-group">
              <label for="id_generator-token">{% trans "Token:" %}</label>
              <input class="form-control" type="number" name="generator-token" autofocus="autofocus" value="{{ form.token.value|default:"" }}" min="1" max="99999999" id="id_generator-token">
            </div>
          {% else %}
            {% include "two_factor/_wizard_forms.html" %}
          {% endif %}

          {# hidden submit button to enable [enter] key #}
          <div style="display: none"><input type="submit" value=""/></div>

          <div class="row">
            <div class="col-sm-12">
              {% include "two_factor/_wizard_actions.html" %}
            </div>
          </div>
        </div>
      </div>
  </form>

{% endblock %}
