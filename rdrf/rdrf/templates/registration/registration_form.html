{% load countries %}
{% load static %}
{% load i18n %}

<html>

<head>
    <title>RDRF | Patient registration</title>
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css">

    <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script src="https://ajax.aspnetcdn.com/ajax/jquery.validate/1.13.1/jquery.validate.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.3/jquery-ui.js"></script>
    <script src="{% static 'js/password.js' %}"></script>
    
    <style>
        body {
            background-color: #edeff1;
            padding-bottom: 70px;
        }
        .top-separator {
            border-top: dotted 1px #bbb;
            padding-top: 20px;
        }
        .bottom-separator {
            border-bottom: dotted 1px #bbb;
            padding-bottom: 20px;
        }
    </style>
    
    <script type="text/javascript">
        $(document).ready(function() {
            $("#id_password1").passStrengthify();

            var _MS_PER_DAY = 1000 * 60 * 60 * 24 * 365;
            var state_lookup_url = "{% url 'v1:state_lookup' 'XX' %}";

            function dateDiffInYears(a, b) {
                var utc2 = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
                var utc1 = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());
            
                return Math.floor((utc2 - utc1) / _MS_PER_DAY);
            }

            $("#parent_guardian_form").hide();
            $("#patient_form").show();
            $("#underage_msg").hide();
            $("#form-other-clinician").hide();
            $("#parent_guardian_form_btn").hide();
            
            var registry_code = "{{registry_code}}"
            
            var dateOptions = {
                'dateFormat': 'yy-mm-dd',
                'showAnim': 'blind',
                'changeMonth': true,
                'changeYear': true,
                'minDate': '-100Y',
                'maxDate': '0',
                'yearRange': '-100:+0',
                'defaultDate': '-30Y'
            }
            
            $("#id_date_of_birth").datepicker(dateOptions);
            $("#id_parent_guardian_date_of_birth").datepicker(dateOptions);
            
            $("#parent_guardian_check1").click(function() {
                $("#parent_guardian_form").hide();
                $("#patient_form").show();
                $("#parent_guardian_form_btn").hide();
                $("#id_is_parent").val(false);
                $("#id_self_patient").val(false);
            });

            $("#parent_guardian_check2").click(function() {
                $("#parent_guardian_form").show();
                $("#patient_form").hide();
                $("#parent_guardian_form_btn").show();
                $("#login_details").show();
                $("#id_is_parent").val(true);
                $("#id_self_patient").val(false);
            });

            $("#parent_guardian_check3").click(function() {
                $("#parent_guardian_form").show();
                $("#patient_form").hide();
                $("#parent_guardian_form_btn").show();
                $("#login_details").show();
                $("#id_is_parent").val(true);
                $("#id_self_patient").val(true);
            });
            
            $("#parent_guardian_check1").trigger("click");

            $("#patient_form_btn").click(function() {
                $("#patient_form").show();
                $("#parent_guardian_form").hide();
            });
            
            $("#parent_guardian_form_btn").click(function() {
                $("#patient_form").hide();
                $("#parent_guardian_form").show();
            });
            
            $.get("{% url 'v1:clinitian_list' registry_code %}", function(data) {
                clinician_drop = $("#id_clinician");
                $.each($.parseJSON(data), function(i, item){
                    clinician_drop.append($('<option>', { value : item.id }).text(item.full_name)); 
                });
                clinician_drop.append($('<option>', { value : 'clinician-other' }).text('Other - not listed'));
            });

            $("#registration-submit").click(function() {
                var registration_form = $("#registration-form");
                $("#id_email").val($("#id_username").val());
                if (registration_form.valid()) {
                    registration_form.submit();
                }
            });

            $('#id_clinician').change(function() {
                if($('#id_clinician option:selected').val() == 'clinician-other') {
                    $("#form-other-clinician").show("blind");
                } else {
                    $("#form-other-clinician").hide("blind");
                }
            });

            $("#id_date_of_birth").change(function() {
                if ($("#id_is_parent").val() == "true") {
                    return;
                }
                date_str = $("#id_date_of_birth").val();
                dob = new Date(date_str);
                if (dateDiffInYears(new Date(),dob) >= 18 ) {
                    $("#underage_msg").hide("blind");
                    $("#patient_form").show("blind");
                } else {
                    $("#underage_msg").show();
                    $("#patient_form").hide();
                    $("#login_details").hide();
                }
            });

            $("#id_country").change(function() {
                var states = $("#id_state");
                states.empty();
                states.append($('<option>', { value : -1 }).text("State / County / Province / Region"));
                $.getJSON( state_lookup_url.replace('XX', this.value), function( data ) {
                    $.each( data, function( key, val ) {
                        states.append($('<option>', { value : val.code }).text(val.name));
                    });
                });
            });

            $("#id_parent_guardian_country").change(function() {
                var states = $("#id_parent_guardian_state");
                states.empty();
                states.append($('<option>', { value : -1 }).text("Parent/Guardian State / County / Province / Region"));
                $.getJSON( state_lookup_url.replace('XX', this.value), function( data ) {
                    $.each( data, function( key, val ) {
                        states.append($('<option>', { value : val.code }).text(val.name));
                    });
                });
            });
        });    
    </script>
</head>

<body>
    <div class="container">
        <br>
    
        {% if form.errors %}
        <div class="alert alert-danger">
            {% for field in form %}
                {% if field.errors %}
                    <p><strong>{{field.label}}</strong> - {{ field.errors|striptags }}</p>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        <div class="alert alert-info">
            <strong>Rare Disease Registry - Patient Registration</strong>
        </div>
        <div id="underage_msg">
            <div class="alert alert-danger">
                For legal reasons you must be 18 or over in order to register here. If you are the parent or guardian of a child that you would like to register as a patient, please enter your own data in this first step. You will be asked for the patientâ€™s data in a later step. If you are a patient who is under 18, please get your parent or guardian to fill in this form with you.
            </div>            
        </div>

        <!-- Registry specific registration form -->
        {% with "registration/registration_form_"|add:registry_code|add:".html" as template_name %}
            {% include template_name %}
        {% endwith %}
 
    </div>
    
    <nav class="navbar navbar-default navbar-fixed-bottom">
        <div class="container" style="padding-top: 10px;">
            <small>
            <p class="text-justify text-muted">
            Privacy Statement - 
            All information we receive from you will be treated confidentially and will be encrypted and stored on a secure server. Your data will not be made available to employers, government organisations, insurance companies or educational institutions, nor to your spouse, other members of your family or your doctor. Only anonymous health information will be made accessible to qualified researchers who are granted permission by the Steering committee. You may also download the TREAT-NMD privacy policy to know more from <a href="www.treat-nmd.eu/downloads/file/registries_toolkit/Charter_Global_Registry_Revised_and_Approved_April_2014.pdf" target="_blank">here</a>.
            </p>
            </small>
        </div>
    </nav>
    
</body>

</html>
