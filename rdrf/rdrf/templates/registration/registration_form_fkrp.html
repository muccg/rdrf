{% load countries %}
{% load static %}
{% load i18n %}
{% load recaptcha_site_key %}

<script type="text/javascript">
    $(document).ready(function(){
        $("#password-error").hide();
        $("#username-error").hide();
        $("#registration-submit").prop("disabled", true);
        
        $("#id_password2").on("keyup", function() {
            var password1 = $("#id_password1").val();
            if (password1 != $(this).val()) {
                $("#password-error").text("The passwords don't match!");
                $("#password-error").show("fast");
            } else {
                $("#password-error").hide("fast");
                $("#registration-submit").prop("disabled", false);
                password_regx = /^(?=.*[0-9])\S{6,}$/
                if(!$(this).val().match(password_regx)) {
                    $("#password-error").text("Password needs to be at least 6 characters long and contain 1 number");
                    $("#password-error").show("fast");
                } else {
                    $("#password-error").hide("fast");
                }
            }
        });
        
        $("#id_username").focusout(function() {
            var url = "{% url 'lookup_username' 'replace-me@domain.com' %}";
            url = url.replace("replace-me@domain.com", $(this).val());
            
            $.getJSON(url, function(data) {
                if (data.existing == true) {
                    $("#username-error").show("fast");
                } else {
                    $("#username-error").hide("fast");
                }
            });
        });
    });
</script>

<div class="alert alert-danger" id="username-error">
    <p>
        <b>Username error:  This username already exists, please choose a different username.</b>
    </p>
    <p>
        If you have already registered with Global FKRP Registry and would like to update your data or add another patient, you
        don't have to register again. Just go to the login page and login with the e-mail address and password you previously registered with.
    </p>    
    <p>
        If you have forgotten your password, please  click on 'forgotten your password?'
    </p>
</div>

<form class="form" id="registration-form" method="POST">
    <div class="row">
        <div class="col-md-6">
            <h3>{% trans "Personal data" %}</h3>
            <h5 style="text-align: justify;">
                {% trans "Please enter your own details here, even if you are not the patient yourself. If you are registering a child as a patient, you will be able to enter his or her details in a later step. Please note that you must be the patient's parent or guardian to enter a patient other than yourself." %}
            </h5>
            <div class="form-group top-separator">
                <label>
                    <input type="radio" checked="checked" name="parent_guardian_check" id="parent_guardian_check1" value="parent_guardian_1">
                    <i>{% trans "I am a patient with the disease" %}</i>
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="radio" name="parent_guardian_check" id="parent_guardian_check2" value="parent_guardian_2">
                    <i>{% trans "I am a parent/guardian of the patient with the disease" %}</i>
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="radio" name="parent_guardian_check" id="parent_guardian_check3" value="parent_guardian_3">
                    <i>{% trans "I am a patient with the disease and I am a parent/guardian of the patient with the disease" %}</i>
                </label>
            </div>
            <div id="login_details" class="top-separator">
                <div class="form-group">
                    <h5><div class="label label-warning">{% trans 'Please provide valid email address as your username' %}</div></h5>
                    <input class="form-control" placeholder="{% trans 'Username' %}" id="id_username" maxlength="50" name="username" type="email" required />
                </div>
                <div class="form-group">
                    <input class="form-control" placeholder="{% trans 'Password' %}" id="id_password1" name="password1" type="password" required />
                </div>
                <div class="form-group">
                    <input class="form-control" placeholder="{% trans 'Repeat Password' %}" id="id_password2" name="password2" type="password" required />
                </div>
                
                <div class="alert alert-danger" id="password-error">
                </div>
            </div>
        </div>
        <div class="col-md-6">
            {% csrf_token %}
            <input type="hidden" name="registry_code" value="{{registry_code}}">
            <input id="id_email" name="email" type="hidden" />
            <input id="id_is_parent" name="is_parent" type="hidden" />
            <input id="id_self_patient" name="self_patient" type="hidden" />
            
            <div id="parent_guardian_form">
                <div class="form-group top-separator">
                    <input class="form-control" placeholder="Parent/Guardian First Name" id="id_parent_guardian_first_name" maxlength="30" name="parent_guardian_first_name" type="text" required />
                </div>
                <div class="form-group">
                    <input class="form-control" placeholder="Parent/Guardian Surname" id="id_parent_guardian_last_name" maxlength="30" name="parent_guardian_last_name" type="text" required />
                </div>
                <div class="form-group">
                    <input class="form-control" placeholder="Parent/Guardian Date of Birth" id="id_parent_guardian_date_of_birth" name="parent_guardian_date_of_birth" type="text" required />
                </div>
                <div class="form-group">
                    <div class="radio">
                        <label><input type="radio" id="id_parent_guardian_gender" name="parent_guardian_gender" value="M">Male</label>
                        <label><input type="radio" id="id_parent_guardian_gender" name="parent_guardian_gender" value="F">Female</label>
                        <label><input type="radio" id="id_parent_guardian_gender" name="parent_guardian_gender" value="I">Indeterminate</label>
                    </div>
                </div>
                <div class="form-group">
                    <input class="form-control" placeholder="Parent/Guardian Address" id="id_parent_guardian_address" maxlength="100" name="parent_guardian_address" type="text" required />
                </div>
                <div class="form-group">
                    <input class="form-control" placeholder="Parent/Guardian Suburb / Town" id="id_parent_guardian_suburb" maxlength="30" name="parent_guardian_suburb" type="text" required />
                </div>
                <div class="form-group">
                    <input class="form-control" placeholder="{% trans 'Parent/Guardian Postcode' %}" id="id_parent_guardian_postcode" maxlength="30" name="parent_guardian_postcode" type="text" required />
                </div>
                <div class="form-group">
                    <select class="form-control" placeholder="{% trans 'Parent/Guardian Country' %}" id="id_parent_guardian_country" name="parent_guardian_country" required>
                        <option value="-1">Country</option>
                        {% countries as countries %}
                        {% for con in countries %}
                            <option value="{{con.alpha2}}">{{con.name}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <select class="form-control" placeholder="Parent/Guardian State / County / Province / Region" id="id_parent_guardian_state" maxlength="30" name="parent_guardian_state" type="text" required>
                        <option value="-1">Parent/Guardian State / County / Province / Region</option>
                    </select>
                </div>
                <div class="form-group">
                    <input class="form-control" placeholder="{% trans 'Parent/Guardian Phone Number' %}" id="id_parent_guardian_phone" name="parent_guardian_phone" type="text" />
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-info" id="patient_form_btn">
                        Patient Details <span class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span>
                    </button>
                </div>
            </div>

            <div id="patient_form">
                <div class="form-group top-separator">
                    <input class="form-control" placeholder="First Name" id="id_first_name" maxlength="30" name="first_name" type="text" required />
                </div>
                <div class="form-group">
                    <input class="form-control" placeholder="Surname" id="id_surname" maxlength="30" name="surname" type="text" required />
                </div>
                <div class="form-group">
                    <input class="form-control" placeholder="Date of Birth" id="id_date_of_birth" name="date_of_birth" type="text" required />
                </div>
                <div class="form-group">
                    <div class="radio">
                        <label><input type="radio" id="id_gender" name="gender" value="M">Male</label>
                        <label><input type="radio" id="id_gender" name="gender" value="F">Female</label>
                        <label><input type="radio" id="id_gender" name="gender" value="I">Indeterminate</label>
                    </div>
                </div>

                <div class="form-group top-separator">
                    <input class="form-control" placeholder="{% trans 'Address' %}" id="id_address" maxlength="100" name="address" type="text" />
                </div>
                <div class="form-group">
                    <input class="form-control" placeholder="{% trans 'Suburb/Town' %}" id="id_suburb" maxlength="30" name="suburb" type="text" />
                </div>
                <div class="form-group">
                    <input class="form-control" placeholder="{% trans 'Postcode' %}" id="id_postcode" maxlength="30" name="postcode" type="text" />
                </div>
                <div class="form-group">
                    <select class="form-control" placeholder="Country" id="id_country" name="country">
                        <option value="-1">Country</option>
                        {% countries as countries %}
                        {% for con in countries %}
                            <option value="{{con.alpha2}}">{{con.name}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <select class="form-control" placeholder="State / County / Province / Region" id="id_state" maxlength="30" name="state" type="text" >
                        <option value="-1">State / County / Province / Region</option>
                    </select>
                </div>
                <div class="form-group">
                    <input class="form-control" placeholder="{% trans 'Phone Number' %}" id="id_phone_number" name="phone_number" type="text" />
                </div>
                <div class="form-group top-separator">
                    <select class="form-control" id="id_clinician" name="clinician">
                        <option value="-1">Choose your preferred Clinician</option>
                    </select>
                </div>
                <div id="form-other-clinician">
                    <div class="form-group">
                        <input class="form-control" placeholder="Clinician's Name" id="id_other_clinician_name" name="other_clinician_name" type="text" />
                    </div>
                    <div class="form-group">
                        <input class="form-control" placeholder="Clinician's Hospital" id="id_other_clinician_hospital" name="other_clinician_hospital" type="text" />
                    </div>
                    <div class="form-group bottom-separator">
                        <input class="form-control" placeholder="Clinician's or Hospital's Address" id="id_other_clinician_address" name="other_clinician_address" type="text" />
                    </div>
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-info" id="parent_guardian_form_btn">
                        <span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span> Parent / Guardian Details
                    </button>
                </div>
                <div class="form-group">
                    <div class="g-recaptcha" data-sitekey="{% recaptcha_site_key %}"  data-callback='reCaptchaCallback'></div>
                </div>
            </div>
            <div class="form-group">
                <button type="button" id="registration-submit" class="btn btn-warning pull-right">Continue</button>
            </div>
        </div>
    </div>
</form>


<script>
    function reCaptchaCallback() {
        r = grecaptcha.getResponse();
        url = "{% url 'recaptcha_validator'%}";
        $.post(url, {"response_value": r, "csrfmiddlewaretoken" : "{{csrf_token}}"}, function(data){
            json_result = $.parseJSON(data);
            if(json_result.success) {
                $("#registration-submit").prop("disabled", false);
            }
        });
    }
</script>