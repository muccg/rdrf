{% extends "rdrf_cdes/base.html" %}
{% load static from staticfiles %}
{% load has_feature %}

{% block extrastyle %}
    {{ block.super }}

    <link rel="stylesheet" href="{% static 'datatables-1.10.12/css/jquery.dataTables.min.css' %}">
    <script type="text/javascript" src="{% static 'datatables-1.10.12/js/jquery.dataTables.min.js' %}"></script>
    
    <script>

        $(document).ready(function() {

            $.ajaxSetup({beforeSend: function (xhr) {
                    var csrfToken = '{{ csrf_token }}';
                    xhr.setRequestHeader('X-CSRFToken', csrfToken);
            }});

            var SERVER_SIDE_API = "{% url 'patientsgridapi'  %}";

            function getDrawLength() {
                try {
                    var length = $("#patient_list_table_length").val();
                    if (length == undefined) {
                        return 10;
                    }
                    return length;
                }

                catch(err) {
                    return 10;
                }
            }

            function getSelectedRegistry() {
                var code = $("#registry_options > option:selected").attr('id');
                return code;
            }

            function getApiUrl(registryCode, drawLength) {
                return  SERVER_SIDE_API + "?registry_code=" + registryCode +
                        "&length=" + drawLength;
            }

            $.fn.dataTable.ext.errMode = 'throw';

            if ( {{ registries.0|has_feature:"no_add_patient_button"|yesno:"false,true" }} == false) {
                $("#add_patient").hide();
            }

            var registryCode = getSelectedRegistry();

            var patients_list = $("#patient_list_table").DataTable({
                "processing": true,
                "serverSide": true,
                ajax: {
                    url: getApiUrl(registryCode, getDrawLength()),
                    dataSrc: "rows"
                },
                columns: {{columns|safe}}
            }).on("draw", function() {
                $("#loading_text").hide();
                $('button[data-toggle=popover]').popover({
                    'html': true,
                    'title': 'Available Modules',
                    'trigger': 'click',
                    'placement': 'bottom',
                    'container': 'body'
                });
            });

            $("#registry_options").change(function() {
                $("#loading_text").show();
                var reg_code = getSelectedRegistry();
                var drawLength = getDrawLength();
                var url = getApiUrl(reg_code, drawLength);
                patients_list.ajax.url(url).load();
            });

            $("#add_patient").click(function() {
                var registryCode = null;
                var addPatientUrl = '{% url "patient_add" "xxx" %}';
                try {
                    registryCode = $("#registry_options option:selected").attr('id');
                    if (registryCode=="---") {
                        alert("Please select registry first");
                        return;
                    }
    
                    if (registryCode == undefined) {
                        registryCode = "{{registries.0.code}}";
                    }
                } catch(err) {
                    // one registry ?
                    registryCode = "{{registries.0.code}}";
                }
                    var location = addPatientUrl.replace("xxx", registryCode);
                    window.location.replace(location);
            });
        });
        
    </script>
{% endblock %}

{% block content %}

    <div class="row">
        <div class="col-md-12">
            <p><h3><span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span> Patient List</h3></p>
            <i class="text-muted"><span class="glyphicon glyphicon-user" aria-hidden="true"></span> {{user.first_name}} {{user.last_name}} ({{user.title}})</i>
        </div>
    </div>

    <hr>

    <div class="clearfix">
        <button id="add_patient" class="btn btn-success pull-right">
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Add
        </button>
    </div>
    
    <p>
        <select id="registry_options">
            {% for reg in registries %}
                <option id="{{ reg.code }}">{{ reg.name }}</option>
            {% endfor %}
        </select>
        <span id="loading_text"><i>Loading...</i></span>
    </p>

    <table id="patient_list_table" class="table table-striped table-hover">
        <thead>
            <tr>
                {% for column in columns %}
                    <th>{{ column.label|safe }}</th>
                {% endfor %}
            </tr>
        </thead>
    </table>
{% endblock %}
