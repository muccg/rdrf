{% extends "rdrf_cdes/base-1-col.html" %}
{% load static from staticfiles %}
{% load has_feature %}
{% load i18n %}
{% load translate %}

{% block content %}
    <div class="row">
        <div class="col-md-12">
            <p><h3><span class="fa fa-list-alt" aria-hidden="true"></span> {% trans 'Query Patient' %}</h3></p>
            <i class="text-muted"><span class="fa fa-user" aria-hidden="true"></span> {{user.first_name}} {{user.last_name}} ({{user.title}})</i>
        </div>
    </div>

    <form>
        <label for="id_umrn">Patient Identifier</label>
        <input type="text" name="umrn" id="id_umrn" placeholder="UMRN or Patient Id"/>
        <button type="button" id="query_patient" class="btn btn-primary me-md-2">
			<span class="fa fa-search" aria-hidden="true"></span> {% trans 'Query Patient' %}
		</button>
    </form>
    Status:
    <div id="status_div"></div>
    Response:
    <div id="response_div"></div>

    <script type="text/javascript" nonce="{{request.csp_nonce}}">
        $.ajaxSetup({
            beforeSend: function (xhr) {
                var csrfToken = '{{ csrf_token }}';
                xhr.setRequestHeader('X-CSRFToken', csrfToken);
            }
        });

        var request_token = "";
        var dataRequestUrl = '{% url "patient_data_request" "registry_code" "umrn" %}';
        dataRequestUrl = dataRequestUrl.replace("registry_code", "{{ registry_code }}");

        var dataRequestDataUrl = '{% url "patient_data_request_data" "registry_code" "token" %}';
        dataRequestDataUrl = dataRequestDataUrl.replace("registry_code", "{{ registry_code }}");

        $dataReceived = false;

        function getResponse() {
            $.ajax({url: dataRequestDataUrl,
                    type: "GET",
                    success: function(result_json) {
                        var result  = jQuery.parseJSON(result_json);
                        if (result.state == "received") {
                            $("#response_div").html(result.data);
                            $("#status_div").html("Received.");
                            $dataReceived = true;
                        } else if (result.state == "requested") {
                            $("#status_div").html("Requested...");
                        } else {
                            $("#status_div").html("Waiting response...");
                        }
                    }
                  });
            if ($dataReceived == false){
                setTimeout(getResponse, 15000);
            }
        }

        $(document).ready(function() {
            $("#query_patient").click(function(){
                $("#status_div").html("Waiting response...");
                dataRequestUrl.replace("umrn", $("#id_umrn").val());
                $.ajax({url: dataRequestUrl,
                        type: "POST",
                        success: function(result_json) {
                            var result  = jQuery.parseJSON(result_json);
                            request_token = result.request_token;
                            dataRequestDataUrl = dataRequestDataUrl.replace("token", request_token);
                            setTimeout(getResponse, 5000);
                        }
                });
            });
        });
    </script>

{% endblock %}


