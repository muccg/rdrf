{% extends "rdrf_cdes/base-1-col.html" %}
{% load static %}
{% load has_feature %}
{% load i18n %}
{% load translate %}

{% block content %}
    <div class="row">
        <div class="col-md-12">
            <p><h3><span class="fa fa-list-alt" aria-hidden="true"></span> {% trans 'Patient Query' %}</h3></p>
            <i class="text-muted"><span class="fa fa-user" aria-hidden="true"></span> {{user.first_name}} {{user.last_name}} ({{user.title}})</i>
        </div>
    </div>

    <p>
        <form>
            <label for="id_umrn">Patient UMRN:</label>
            <input type="text" name="umrn" id="id_umrn" placeholder="UMRN"/>
            <button type="button" id="query_patient" class="btn btn-primary me-md-2">
                <span class="fa fa-search" aria-hidden="true"></span> {% trans 'Patient Query' %}
            </button>
            <span id="status_div"></span>
        </form>
    </p>

    <div class="card invisible" id="data_received">
        <div class="card-header">
            <span class="h5" id="patient_status">Patient Created</span>
            <a href="" id="patient_url"></a> (Patient has been subscribed for future updates)
        </div>
        <div class="card-body" id="response_div">
              <table id="patient_table" class="table table-striped table-hover">
                  <tbody>
		     <tr>
                          <td>UMRN</td><td id="umrn"></td>
                      </tr>

                      <tr>
                          <td>Given Names</td><td id="given_names"></td>
                      </tr>
                      <tr>
                          <td>Last Name</td><td id="last_name"></td>
                      </tr>
                      <tr>
                          <td>Date of Birth</td><td id="dob"></td>
                      </tr>
                  </tbody>
              </table>
        </div>
	<!--
        <div class="card-footer invisible" id="submit_div">
            <button type="button" id="accept_button" class="btn btn-success me-md-2">
                <span class="fa fa-thumbs-o-up" aria-hidden="true"></span> {% trans 'Accept' %}
            </button>
            <button type="button" id="reject_button" class="btn btn-danger me-md-2">
                <span class="fa fa-thumbs-o-down" aria-hidden="true"></span> {% trans 'Reject' %}
            </button>
        </div>
	-->
    </div>

    <script type="text/javascript" nonce="{{request.csp_nonce}}">
        $.ajaxSetup({
            beforeSend: function (xhr) {
                var csrfToken = '{{ csrf_token }}';
                xhr.setRequestHeader('X-CSRFToken', csrfToken);
            }
        });

        var requestToken = "";
        var hubUrl = '{% url "integrations:hub" "registry_code" "umrn" %}';
        hubUrl = hubUrl.replace("registry_code", "{{ registry_code }}");

        var dataReceived = false;

        $(document).ready(function() {
            $("#query_patient").click(function(){
                $("#status_div").html("Waiting response...");
                hubUrl = hubUrl.replace("umrn", $("#id_umrn").val());
                $.ajax({url: hubUrl,
                        type: "GET",
                        success: function(resultJson) {
                            var result  = jQuery.parseJSON(resultJson);
			                if (result.status == "success") {
                                $("#data_received").removeClass("invisible");
                                $("#umrn").html(result['umrn']);
                                $("#given_names").html(result["given_names"]);
                                $("#last_name").html(result["family_name"]);
                                $("#dob").html(result["date_of_birth"]);
                                $("#status_div").html("");
                                if (result["patient_updated"]) {
                                    $("#patient_status").html("Patient details updated");
                                }
                                $("#submit_div").removeClass("invisible");
                                var url = result["patient_url"]
                                $("#patient_url").attr("href", url);
                                $("#patient_url").html(result["family_name"] + ' ' + result["given_names"]);
                                dataReceived = true;
                            } else {
                                if (result.status == "connection_error") {
                                    $("#status_div").html("Could not connect to hub - please try again.");
                                } else {
                                    if (result.status == "fail") {
                                        $("#status_div").html("The query failed - please try again.");
                                    } else {
                                        $("#status_div").html("Patient with that UMRN was not found.");
                                    }
                                }
                            }
                        }
                });
            });

            $("#accept_button").click(function(){
                console.log("accept");
            });

            $("#reject_button").click(function(){
                console.log("reject");
            });
        });
    </script>
{% endblock %}
