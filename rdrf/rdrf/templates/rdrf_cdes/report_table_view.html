{% extends "rdrf_cdes/base.html" %}
{% load static from staticfiles %}
{%  block htmltype %}
    <!doctype html>
    <html lang="en">
{%  endblock %}
{% block extrastyle %}
    {{ block.super }}
     <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/s/bs/jszip-2.5.0,pdfmake-0.1.18,dt-1.10.10,b-1.1.0,b-colvis-1.1.0,b-flash-1.1.0,b-html5-1.1.0,b-print-1.1.0,cr-1.3.0,fc-3.2.0,fh-3.1.0,kt-2.1.0,r-2.0.0,rr-1.1.0,sc-1.4.0/datatables.min.css"/>

{% endblock %}

{% block extrahead %}
<script type="text/javascript" src="https://cdn.datatables.net/s/bs/jszip-2.5.0,pdfmake-0.1.18,dt-1.10.10,b-1.1.0,b-colvis-1.1.0,b-flash-1.1.0,b-html5-1.1.0,b-print-1.1.0,cr-1.3.0,fc-3.2.0,fh-3.1.0,kt-2.1.0,r-2.0.0,rr-1.1.0,sc-1.4.0/datatables.min.js"></script>




    <script>
    $.fn.dataTable.ext.errMode = 'throw';
    var COLUMNS = {{columns|safe }};
    var TABLE_ID = "report_table";
    var TABLE_LENGTH_SELECT = "report_table_length";

    var Report = function(registryCode, columns, length) {
        this.registryCode = registryCode;
        this.baseApiUrl = "{{ api_url  }}";
        this.length = length;
        this.table = $("#" + TABLE_ID).DataTable({"processing": true,
                                                   "serverSide": true,
                                                    ajax: {
                                                        url: this.getUrl(),
                                                        dataSrc: "rows",
                                                        type: "POST"
                                                    },
                                                    columns: columns,
                                                    dom: 'Brt',
                                                    colReorder: true,
                                                    stateSave: true,
                                                    scrollX: true,
                                                    buttons: [
                                                            'colvis', 'copy', 'csv','excel', 'print'
                                                    ],
                                                    fixedHeader: true
                                                   });
    };

    Report.prototype.getApiUrl = function(registryCode) {
        return  this.baseApiUrl + "?registry_code=" + registryCode + "&length=" + this.length;
    };

    Report.prototype.getUrl = function () {
        return this.getApiUrl(this.registryCode);
    };


    Report.prototype.load = function() {
        var url = this.getUrl();
        alert(url);
        this.table.ajax.url(url).load();
    }

    function setUpCSRFToken() {
         $.ajaxSetup({beforeSend: function (xhr) {
                    var csrfToken = '{{ csrf_token }}';
                    xhr.setRequestHeader('X-CSRFToken', csrfToken);
                }});
    }

    $(document).ready(
            function () {
                setUpCSRFToken();
                var registryCode = "{{ registry_code }}";
                var initial_length = 10;
                var report = new Report(registryCode, COLUMNS, initial_length);

            });
    </script>

{% endblock %}

{% block content %}

    <div class="row">
        <div class="col-md-12">
            <p><h3><span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span> Report - {{ report_title }}</h3></p>
            <i class="text-muted"><span class="glyphicon glyphicon-user" aria-hidden="true"></span> {{user.first_name}} {{user.last_name}} ({{user.title}})</i>
        </div>
    </div>

    <br>

    <div class="well">
        <table id="report_table" class="display table table-striped table-hover">
        <thead>
            <tr>
                {% for column in columns %}
                    <th>{{ column.label|safe }}</th>
                {% endfor %}
            </tr>
        </thead>
        </table>

    </div>

{% endblock %}
